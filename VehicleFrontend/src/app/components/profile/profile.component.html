<app-navbar></app-navbar>

<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="min-h-screen bg-gray-50 py-8">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">Мој профил</h1>

    <!-- User Profile Section -->
    <div class="mb-8">
      <p-card>
        <ng-template pTemplate="header">
          <div class="p-4 bg-blue-600 text-white">
            <h2 class="text-xl font-semibold">Подаци о кориснику</h2>
          </div>
        </ng-template>

        <form [formGroup]="profileForm" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="username" class="block text-sm font-medium text-gray-700 mb-1">
                Корисничко име
              </label>
              <input
                id="username"
                type="text"
                pInputText
                formControlName="username"
                class="w-full"
              />
            </div>

            <div>
              <label for="email" class="block text-sm font-medium text-gray-700 mb-1">
                Е-пошта
              </label>
              <input
                id="email"
                type="email"
                pInputText
                formControlName="email"
                class="w-full"
              />
            </div>

            <div>
              <label for="role" class="block text-sm font-medium text-gray-700 mb-1">
                Улога
              </label>
              <input
                id="role"
                type="text"
                pInputText
                formControlName="role"
                class="w-full bg-gray-100"
                readonly
              />
              <small class="text-gray-500">Улога се не може мењати</small>
            </div>
          </div>

          @if (profileError()) {
            <p-message severity="error" [text]="profileError()"></p-message>
          }

          <div class="flex gap-2">
            @if (!isEditingProfile()) {
              <p-button
                label="Измени профил"
                icon="pi pi-pencil"
                (onClick)="enableProfileEdit()"
              ></p-button>
              <p-button
                label="Промени лозинку"
                icon="pi pi-key"
                severity="secondary"
                (onClick)="togglePasswordChange()"
              ></p-button>
            } @else {
              <p-button
                label="Сачувај"
                icon="pi pi-check"
                [loading]="isLoadingProfile()"
                (onClick)="saveProfile()"
              ></p-button>
              <p-button
                label="Откажи"
                icon="pi pi-times"
                severity="secondary"
                (onClick)="cancelProfileEdit()"
              ></p-button>
            }
          </div>
        </form>
      </p-card>
    </div>

    <!-- Change Password Section -->
    @if (isChangingPassword()) {
      <div class="mb-8">
        <p-card>
          <ng-template pTemplate="header">
            <div class="p-4 bg-orange-600 text-white">
              <h2 class="text-xl font-semibold">Промена лозинке</h2>
            </div>
          </ng-template>

          <form [formGroup]="passwordForm" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label for="currentPassword" class="block text-sm font-medium text-gray-700 mb-1">
                  Тренутна лозинка
                </label>
                <p-password
                  id="currentPassword"
                  formControlName="currentPassword"
                  [feedback]="false"
                  [toggleMask]="true"
                  styleClass="w-full"
                ></p-password>
              </div>

              <div>
                <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-1">
                  Нова лозинка
                </label>
                <p-password
                  id="newPassword"
                  formControlName="newPassword"
                  [toggleMask]="true"
                  styleClass="w-full"
                ></p-password>
              </div>

              <div>
                <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-1">
                  Потврди нову лозинку
                </label>
                <p-password
                  id="confirmPassword"
                  formControlName="confirmPassword"
                  [feedback]="false"
                  [toggleMask]="true"
                  styleClass="w-full"
                ></p-password>
              </div>
            </div>

            @if (passwordForm.hasError('passwordMismatch')) {
              <p-message severity="error" text="Лозинке се не поклапају"></p-message>
            }

            @if (passwordError()) {
              <p-message severity="error" [text]="passwordError()"></p-message>
            }

            <div class="flex gap-2">
              <p-button
                label="Промени лозинку"
                icon="pi pi-check"
                [loading]="isLoadingPassword()"
                (onClick)="changePassword()"
              ></p-button>
              <p-button
                label="Откажи"
                icon="pi pi-times"
                severity="secondary"
                (onClick)="togglePasswordChange()"
              ></p-button>
            </div>
          </form>
        </p-card>
      </div>
    }

    <!-- User Vehicles Section -->
    <div>
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-900">Моја возила</h2>
        <p-button
          label="Додај возило"
          icon="pi pi-plus"
          (onClick)="openCreateDialog()"
        ></p-button>
      </div>

      @if (isLoadingVehicles()) {
        <div class="text-center py-8">
          <i class="pi pi-spin pi-spinner text-4xl text-blue-600"></i>
          <p class="mt-2 text-gray-600">Учитавање возила...</p>
        </div>
      } @else if (userVehicles().length === 0) {
        <p-card>
          <div class="text-center py-8">
            <i class="pi pi-car text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-600 text-lg">Немате регистрованих возила</p>
          </div>
        </p-card>
      } @else {
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          @for (vehicle of userVehicles(); track vehicle.id) {
            <p-card>
              <ng-template pTemplate="header">
                <div class="p-4"
                  [class.bg-red-100]="isVehicleExpired(vehicle)"
                  [class.bg-orange-100]="isVehicleExpiringSoon(vehicle) && !isVehicleExpired(vehicle)"
                  [class.bg-blue-100]="!isVehicleExpiringSoon(vehicle) && !isVehicleExpired(vehicle)"
                >
                  <h3 class="text-xl font-bold"
                    [class.text-red-900]="isVehicleExpired(vehicle)"
                    [class.text-orange-900]="isVehicleExpiringSoon(vehicle) && !isVehicleExpired(vehicle)"
                    [class.text-blue-900]="!isVehicleExpiringSoon(vehicle) && !isVehicleExpired(vehicle)"
                  >
                    {{ vehicle.make }} {{ vehicle.model }}
                  </h3>
                </div>
              </ng-template>

              <div class="space-y-2">
                <div class="flex justify-between">
                  <span class="font-semibold text-gray-700">Регистарска таблица:</span>
                  <span class="text-gray-900">{{ vehicle.registrationNumber }}</span>
                </div>
                <div class="flex justify-between">
                  <span class="font-semibold text-gray-700">Број шасије:</span>
                  <span class="text-gray-900">{{ vehicle.chassisNumber }}</span>
                </div>
                <div class="flex justify-between">
                  <span class="font-semibold text-gray-700">Година производње:</span>
                  <span class="text-gray-900">{{ vehicle.year }}</span>
                </div>
                <div class="flex justify-between">
                  <span class="font-semibold text-gray-700">Истиче:</span>
                  <span
                    [class.text-red-600]="isVehicleExpired(vehicle)"
                    [class.text-orange-600]="isVehicleExpiringSoon(vehicle) && !isVehicleExpired(vehicle)"
                    [class.font-bold]="isVehicleExpired(vehicle) || isVehicleExpiringSoon(vehicle)"
                  >
                    {{ formatDate(vehicle.expirationDate) }}
                  </span>
                </div>

                @if (isVehicleExpired(vehicle)) {
                  <div class="bg-red-100 border border-red-400 text-red-700 px-3 py-2 rounded">
                    <i class="pi pi-exclamation-triangle mr-2"></i>
                    <strong>Регистрација истекла!</strong>
                  </div>
                } @else if (isVehicleExpiringSoon(vehicle)) {
                  <div class="bg-orange-100 border border-orange-400 text-orange-700 px-3 py-2 rounded">
                    <i class="pi pi-exclamation-circle mr-2"></i>
                    <strong>Регистрација ускоро истиче!</strong>
                  </div>
                }
              </div>

              <ng-template pTemplate="footer">
                <div class="flex gap-2 justify-end">
                  <p-button
                    icon="pi pi-pencil"
                    label="Измени"
                    severity="secondary"
                    size="small"
                    (onClick)="openEditDialog(vehicle)"
                  ></p-button>
                  <p-button
                    icon="pi pi-trash"
                    label="Обриши"
                    severity="danger"
                    size="small"
                    (onClick)="deleteVehicle(vehicle)"
                  ></p-button>
                </div>
              </ng-template>
            </p-card>
          }
        </div>
      }
    </div>
  </div>
</div>

<!-- Edit Vehicle Dialog -->
<p-dialog
  header="Измена возила"
  [(visible)]="showEditDialog"
  [modal]="true"
  [style]="{ width: '50rem' }"
  (onHide)="closeEditDialog()"
>
  <form [formGroup]="editVehicleForm" class="space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label for="editRegistrationNumber" class="block text-sm font-medium text-gray-700 mb-1">
          Регистарска таблица
        </label>
        <input
          id="editRegistrationNumber"
          type="text"
          pInputText
          formControlName="registrationNumber"
          class="w-full bg-gray-100"
          readonly
        />
        <small class="text-gray-500">Регистарска таблица се не може мењати</small>
      </div>



      <div>
        <label for="editMake" class="block text-sm font-medium text-gray-700 mb-1">
          Произвођач *
        </label>
        <input
          id="editMake"
          type="text"
          pInputText
          formControlName="make"
          placeholder="нпр. Volkswagen"
          class="w-full"
        />
        @if (editVehicleForm.get('make')?.invalid && editVehicleForm.get('make')?.touched) {
          <small class="text-red-600">Произвођач је обавезан</small>
        }
      </div>

      <div>
        <label for="editModel" class="block text-sm font-medium text-gray-700 mb-1">
          Модел *
        </label>
        <input
          id="editModel"
          type="text"
          pInputText
          formControlName="model"
          placeholder="нпр. Golf"
          class="w-full"
        />
        @if (editVehicleForm.get('model')?.invalid && editVehicleForm.get('model')?.touched) {
          <small class="text-red-600">Модел је обавезан</small>
        }
      </div>

      <div>
        <label for="editYear" class="block text-sm font-medium text-gray-700 mb-1">
          Година производње *
        </label>
        <input
          id="editYear"
          type="number"
          pInputText
          formControlName="year"
          placeholder="нпр. 2020"
          class="w-full"
        />
        @if (editVehicleForm.get('year')?.invalid && editVehicleForm.get('year')?.touched) {
          <small class="text-red-600">Година мора бити између 1900 и {{ currentYear }}</small>
        }
      </div>

      <div>
        <label for="editOwnerName" class="block text-sm font-medium text-gray-700 mb-1">
          Име власника *
        </label>
        <input
          id="editOwnerName"
          type="text"
          pInputText
          formControlName="ownerName"
          class="w-full bg-gray-100"
          readonly
        />
        <small class="text-gray-500">Име власника се не може мењати</small>
      </div>

      <div>
        <label for="editExpirationDate" class="block text-sm font-medium text-gray-700 mb-1">
          Датум истека регистрације
        </label>
        <input
          id="editExpirationDate"
          type="text"
          pInputText
          [value]="selectedVehicle() ? formatDate(selectedVehicle()!.expirationDate) : ''"
          class="w-full bg-gray-100"
          readonly
        />
        <small class="text-gray-500">Датум истека се не може мењати</small>
      </div>
    </div>

    @if (editVehicleError()) {
      <p-message severity="error" [text]="editVehicleError()"></p-message>
    }
  </form>

  <ng-template pTemplate="footer">
    <div class="flex gap-2 justify-end">
      <p-button
        label="Откажи"
        icon="pi pi-times"
        severity="secondary"
        (onClick)="closeEditDialog()"
      ></p-button>
      <p-button
        label="Сачувај измене"
        icon="pi pi-check"
        [loading]="isUpdatingVehicle()"
        (onClick)="updateVehicle()"
      ></p-button>
    </div>
  </ng-template>
</p-dialog>

<!-- Create Vehicle Dialog -->
<p-dialog
  header="Додај ново возило"
  [(visible)]="showCreateDialog"
  [modal]="true"
  [style]="{ width: '40rem' }"
  (onHide)="closeCreateDialog()"
>
  <form [formGroup]="createVehicleForm" class="space-y-4">
    <div>
      <label for="registrationNumber" class="block text-sm font-medium text-gray-700 mb-1">
        Регистарска таблица *
      </label>
      <input
        id="registrationNumber"
        type="text"
        pInputText
        formControlName="registrationNumber"
        placeholder="нпр. BG-123-AB"
        class="w-full"
      />
      @if (createVehicleForm.get('registrationNumber')?.invalid && createVehicleForm.get('registrationNumber')?.touched) {
        <small class="text-red-600">Регистарска таблица је обавезна</small>
      }
    </div>

    <div>
      <label for="make" class="block text-sm font-medium text-gray-700 mb-1">
        Произвођач *
      </label>
      <input
        id="make"
        type="text"
        pInputText
        formControlName="make"
        placeholder="нпр. Volkswagen"
        class="w-full"
      />
      @if (createVehicleForm.get('make')?.invalid && createVehicleForm.get('make')?.touched) {
        <small class="text-red-600">Произвођач је обавезан</small>
      }
    </div>

    <div>
      <label for="model" class="block text-sm font-medium text-gray-700 mb-1">
        Модел *
      </label>
      <input
        id="model"
        type="text"
        pInputText
        formControlName="model"
        placeholder="нпр. Golf"
        class="w-full"
      />
      @if (createVehicleForm.get('model')?.invalid && createVehicleForm.get('model')?.touched) {
        <small class="text-red-600">Модел је обавезан</small>
      }
    </div>

    <div>
      <label for="year" class="block text-sm font-medium text-gray-700 mb-1">
        Година производње *
      </label>
      <input
        id="year"
        type="number"
        pInputText
        formControlName="year"
        placeholder="нпр. 2020"
        class="w-full"
      />
      @if (createVehicleForm.get('year')?.invalid && createVehicleForm.get('year')?.touched) {
        <small class="text-red-600">Година мора бити између 1900 и {{ currentYear }}</small>
      }
    </div>

    @if (createVehicleError()) {
      <p-message severity="error" [text]="createVehicleError()"></p-message>
    }
  </form>

  <ng-template pTemplate="footer">
    <div class="flex gap-2 justify-end">
      <p-button
        label="Откажи"
        icon="pi pi-times"
        severity="secondary"
        (onClick)="closeCreateDialog()"
      ></p-button>
      <p-button
        label="Додај возило"
        icon="pi pi-check"
        [loading]="isCreatingVehicle()"
        (onClick)="createVehicle()"
      ></p-button>
    </div>
  </ng-template>
</p-dialog>
